import * as XLSX from 'xlsx';
import path from 'path';

export interface TestRow {
  testCaseName: string;
  execute: string;
  [key: string]: any;
}

/**
 * Read all rows from a sheet
 */
export function readSheet(excelFile: string, sheetName: string): TestRow[] {
  const workbookPath = path.resolve(`data/testdata/${excelFile}`);
  const workbook = XLSX.readFile(workbookPath);

  if (!workbook.SheetNames.includes(sheetName)) return [];

  return XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
}


import { TestRow, readSheet } from './excelReader';
import { getRunList } from './runListReader';
import { getSuiteList } from './suiteReader';
import { getExecutionMode, getSuiteName } from './configManager';

const mode = getExecutionMode();
const suiteName = getSuiteName();

// Cache for each sheet
const sheetCache: Record<string, TestRow[]> = {};

/**
 * Get all executable test names for a sheet
 */
export function getExecutableTests(excelFile: string, sheetName: string): string[] {
  const sheetData = getSheetData(excelFile, sheetName);

  if (mode === 'excel') {
    return sheetData.filter(row => row.execute?.toLowerCase() === 'yes')
                    .map(row => row.testCaseName);
  }

  if (mode === 'runlist') {
    const runList = getRunList();
    return runList?.[sheetName] || [];
  }

  if (mode === 'suite') {
    const suiteTests = getSuiteList(suiteName!);
    return suiteTests;
  }

  return [];
}

/**
 * Fetch a single test case's data from cached sheet
 */
export function getTestData(excelFile: string, sheetName: string, testCaseName: string): TestRow | null {
  const sheetData = getSheetData(excelFile, sheetName);
  return sheetData.find(row => row.testCaseName === testCaseName) || null;
}

/**
 * Read sheet once and cache it
 */
function getSheetData(excelFile: string, sheetName: string): TestRow[] {
  const cacheKey = `${excelFile}_${sheetName}`;
  if (!sheetCache[cacheKey]) {
    sheetCache[cacheKey] = readSheet(excelFile, sheetName);
  }
  return sheetCache[cacheKey];
}


export type Mode = 'excel' | 'runlist' | 'suite';

export function getExecutionMode(): Mode {
  return (process.env.EXEC_MODE as Mode) || 'excel';
}

export function getSuiteName(): string | null {
  return process.env.SUITE_NAME || null;
}





