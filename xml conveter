import * as fs from "fs";
import { XMLParser } from "fast-xml-parser";

export function convertJUnitToCustomXML(inputFile: string, outputFile: string) {
  const xmlData = fs.readFileSync(inputFile, "utf-8");

  const parser = new XMLParser({ ignoreAttributes: false });
  const jsonObj = parser.parse(xmlData);

  const testSuites = jsonObj.testsuites.testsuite;
  let passed: any[] = [];
  let failed: any[] = [];
  let skipped: any[] = [];

  for (const suite of Array.isArray(testSuites) ? testSuites : [testSuites]) {
    const testCases = suite.testcase;
    for (const tc of Array.isArray(testCases) ? testCases : [testCases]) {
      const name = tc["@_name"];
      const script = { "@_id": "", "@_name": name };

      if (tc.failure) {
        failed.push(script);
      } else if (tc.skipped !== undefined) {
        skipped.push(script);
      } else {
        passed.push(script);
      }
    }
  }

  let resultXml = `<resultsData>\n`;

  if (failed.length > 0) {
    resultXml += `  <failed>\n`;
    failed.forEach(tc => {
      resultXml += `    <testScript id="${tc['@_id']}" name="${tc['@_name']}"/>\n`;
    });
    resultXml += `  </failed>\n`;
  }

  if (passed.length > 0) {
    resultXml += `  <passed>\n`;
    passed.forEach(tc => {
      resultXml += `    <testScript id="${tc['@_id']}" name="${tc['@_name']}"/>\n`;
    });
    resultXml += `  </passed>\n`;
  }

  if (skipped.length > 0) {
    resultXml += `  <skipped>\n`;
    skipped.forEach(tc => {
      resultXml += `    <testScript id="${tc['@_id']}" name="${tc['@_name']}"/>\n`;
    });
    resultXml += `  </skipped>\n`;
  }

  // executing placeholder (always present)
  resultXml += `  <executing/>\n`;

  // total count
  resultXml += `  <numberOfScripts>${passed.length + failed.length + skipped.length}</numberOfScripts>\n`;

  resultXml += `</resultsData>\n`;

  fs.writeFileSync(outputFile, resultXml, "utf-8");

  console.log(`‚úÖ Custom XML report created at: ${outputFile}`);
}




import type { PlaywrightTestConfig, FullConfig } from "@playwright/test";
import { convertJUnitToCustomXML } from "./convert-report";

// Helper to generate timestamp: YYYYMMDD_HHMMSS
function getTimestamp() {
  const now = new Date();
  const pad = (n: number) => n.toString().padStart(2, "0");
  return (
    now.getFullYear().toString() +
    pad(now.getMonth() + 1) +
    pad(now.getDate()) +
    "_" +
    pad(now.getHours()) +
    pad(now.getMinutes()) +
    pad(now.getSeconds())
  );
}

// Global teardown function
async function globalTeardown(config: FullConfig) {
  const timestamp = getTimestamp();

  // Input JUnit XML (generated by Playwright reporter)
  const inputFile = "results/junit-results.xml";

  // Output custom XML with timestamp
  const outputFile = `results/custom-results_${timestamp}.xml`;

  console.log(`üìù Converting ${inputFile} ‚Üí ${outputFile}`);
  convertJUnitToCustomXML(inputFile, outputFile);
}

// Playwright configuration
const config: PlaywrightTestConfig = {
  testDir: "./tests", // adjust if your test folder is different
  timeout: 30 * 1000, // 30s per test
  reporter: [
    ["junit", { outputFile: "results/junit-results.xml" }], // JUnit XML
    ["list"], // optional console reporter
  ],
  globalTeardown, // <-- runs automatically after all tests
  use: {
    headless: true, // run in headless mode
    screenshot: "only-on-failure",
    trace: "on-first-retry",
  },
};

export default config;


import { FullConfig } from "@playwright/test";
import { convertJUnitToCustomXML } from "./convert-report";
import path from "path";
import fs from "fs";

// Helper: generate timestamp YYYYMMDD_HHMMSS
function getTimestamp() {
  const now = new Date();
  const pad = (n: number) => n.toString().padStart(2, "0");
  return (
    now.getFullYear().toString() +
    pad(now.getMonth() + 1) +
    pad(now.getDate()) +
    "_" +
    pad(now.getHours()) +
    pad(now.getMinutes()) +
    pad(now.getSeconds())
  );
}

// Helper: get the latest file in a folder
function getLatestFile(folder: string): string | null {
  const files = fs.readdirSync(folder)
    .map(f => ({ name: f, time: fs.statSync(path.join(folder, f)).mtime.getTime() }))
    .sort((a, b) => b.time - a.time);
  return files.length ? path.join(folder, files[0].name) : null;
}

// Default export required by Playwright
export default async function globalTeardown(config: FullConfig) {
  const timestamp = getTimestamp();
  const resultsFolder = path.resolve(process.cwd(), "results");

  // Automatically pick latest JUnit XML file
  const inputFile = getLatestFile(resultsFolder);
  if (!inputFile) {
    console.warn("‚ö†Ô∏è No JUnit XML files found in results folder. Skipping conversion.");
    return;
  }

  const outputFile = path.resolve(resultsFolder, `custom-results_${timestamp}.xml`);

  console.log(`üìù Converting latest JUnit file ${inputFile} ‚Üí ${outputFile}`);
  convertJUnitToCustomXML(inputFile, outputFile);
}


import { FullConfig } from "@playwright/test";
import { convertJUnitToCustomXML } from "./convert-report";
import path from "path";
import fs from "fs";

// Default export required by Playwright
export default async function globalTeardown(config: FullConfig) {

  // Input JUnit XML file in 'junit-results' folder
  const inputFile = path.resolve(process.cwd(), "junit-results/junit-results.xml");

  // Output folder 'Results' (created if doesn't exist)
  const outputFolder = path.resolve(process.cwd(), "Results");
  if (!fs.existsSync(outputFolder)) fs.mkdirSync(outputFolder, { recursive: true });

  // Output file fixed name: results.xml
  const outputFile = path.join(outputFolder, "results.xml");

  if (!fs.existsSync(inputFile)) {
    console.warn(`‚ö†Ô∏è Input file not found: ${inputFile}`);
    return;
  }

  console.log(`üìù Converting ${inputFile} ‚Üí ${outputFile}`);
  convertJUnitToCustomXML(inputFile, outputFile);
}

