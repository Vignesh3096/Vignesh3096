import org.openqa.selenium.WebDriver;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
import org.openqa.selenium.devtools.DevTools;
import org.openqa.selenium.devtools.Command;

import java.util.Map;

public class BaseClass {

    // ThreadLocal WebDriver for parallel execution
    protected static ThreadLocal<WebDriver> driver = new ThreadLocal<>();

    // ThreadLocal DevTools for the current driver
    protected static ThreadLocal<DevTools> devTools = new ThreadLocal<>();

    // Initialize EdgeDriver + DevTools
    public void initializeBrowser() {

        EdgeOptions options = new EdgeOptions();
        options.setExperimentalOption("w3c", false); // required for DevTools

        // Create driver and store in ThreadLocal
        EdgeDriver edgeDriver = new EdgeDriver(options);
        driver.set(edgeDriver);

        // Create DevTools session and store in ThreadLocal
        DevTools dt = edgeDriver.getDevTools();
        dt.createSession();
        devTools.set(dt);

        // Set auto-download folder for this thread
        String downloadPath = System.getProperty("user.dir") + "\\downloads\\" + Thread.currentThread().getId();

        dt.send(new Command<>(
                "Page.setDownloadBehavior",
                Map.of(
                        "behavior", "allow",
                        "downloadPath", downloadPath
                )
        ));
    }

    // Get current thread WebDriver
    public static WebDriver getDriver() {
        return driver.get();
    }

    // Get current thread DevTools
    public static DevTools getDevTools() {
        return devTools.get();
    }

    // Quit driver and cleanup ThreadLocal
    public static void quitBrowser() {
        if(driver.get() != null) {
            driver.get().quit();
            driver.remove();
            devTools.remove();
        }
    }
}