import fs from 'fs';
import path from 'path';
import dotenv from 'dotenv';

dotenv.config({ path: path.resolve(__dirname, './config/.env') });

export default async function globalSetup() {
  const resultsFolder = process.env.ALLURE_RESULTS!;
  console.log('🧹 Global Setup: Cleaning allure-results folder:', resultsFolder);

  if (fs.existsSync(resultsFolder)) {
    fs.rmSync(resultsFolder, { recursive: true, force: true });
    console.log('🗑️ Old allure-results deleted');
  }

  fs.mkdirSync(resultsFolder, { recursive: true });
  console.log('📁 Fresh allure-results folder created');
}


import fs from 'fs';
import path from 'path';
import { execSync } from 'child_process';
import dotenv from 'dotenv';
import AdmZip from 'adm-zip';

dotenv.config({ path: path.resolve(__dirname, './config/.env') });

export default async function globalTeardown() {
  const resultsFolder = process.env.ALLURE_RESULTS!;
  const reportFolder = process.env.ALLURE_REPORT!;
  const generate = process.env.ALLURE_GENERATE === 'true';

  if (!fs.existsSync(resultsFolder)) {
    console.warn('⚠️ allure-results folder does not exist. No report will be generated.');
    return;
  }

  const files = fs.readdirSync(resultsFolder);
  if (files.length === 0) {
    console.warn('⚠️ No test results found in allure-results.');
    return;
  }

  if (generate) {
    try {
      console.log('📊 Generating Allure report...');
      execSync(`npx allure generate "${resultsFolder}" -o "${reportFolder}" --clean`, { stdio: 'inherit' });
      console.log('✅ Allure report generated at:', reportFolder);

      // Zip the report for easy sharing
      const zip = new AdmZip();
      zip.addLocalFolder(reportFolder);
      const zipPath = path.join(path.dirname(reportFolder), 'allure-report.zip');
      zip.writeZip(zipPath);
      console.log('📦 Allure report zipped at:', zipPath);

      // Portable launcher for opening report
      const launcherPath = path.join(path.dirname(reportFolder), 'open-allure-report.bat');
      fs.writeFileSync(
        launcherPath,
        `@echo off\nstart chrome "${reportFolder}/index.html"`,
        'utf-8'
      );
      console.log('🚀 Portable launcher created:', launcherPath);
    } catch (err) {
      console.error('❌ Failed to generate Allure report:', err);
    }
  }
}



