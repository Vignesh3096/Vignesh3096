import fs from "fs";
import path from "path";
import { execSync } from "child_process";
import AdmZip from "adm-zip";
import dotenv from "dotenv";

dotenv.config({ path: path.resolve(__dirname, "./config/.env") });

export default async function globalTeardown() {
  try {
    const enableAllure = process.env.ENABLE_ALLURE === "true";
    const openAllure = process.env.OPEN_ALLURE === "true";
    const baseReportPath = process.env.BASE_REPORT_PATH || "C:\\playwrightReports";
    const resultsDir = path.resolve(process.cwd(), process.env.ALLURE_RESULTS || "allure-results");
    const reportDir = path.join(baseReportPath, "allure-report");
    const backupDir = path.join(baseReportPath, "allure-backup");

    if (!enableAllure) {
      console.log("ğŸš« Allure disabled. Skipping report generation.");
      return;
    }

    // Ensure base dirs exist
    [baseReportPath, backupDir].forEach((dir) => {
      if (!fs.existsSync(dir)) fs.mkdirSync(dir, { recursive: true });
    });

    console.log("ğŸ“Š Generating Allure report...");
    execSync(`npx allure generate "${resultsDir}" --clean -o "${reportDir}"`, {
      stdio: "inherit",
    });
    console.log(`âœ… Allure report generated at: ${reportDir}`);

    // Optionally open report
    if (openAllure) {
      console.log("ğŸŒ Opening Allure report in browser...");
      execSync(`npx allure open "${reportDir}"`, { stdio: "inherit" });
    }

    // Create server file (for devs)
    const serverScript = `
      const express = require('express');
      const app = express();
      const path = require('path');
      const PORT = 8080;
      app.use(express.static(path.join(__dirname)));
      app.listen(PORT, () => console.log('ğŸ“Š Allure report running at http://localhost:' + PORT));
    `;
    fs.writeFileSync(path.join(reportDir, "start_server.js"), serverScript);

    // ğŸªŸ Create simple batch file for managers
    const batScript = `
@echo off
echo Opening Allure Test Report...
start "" "index.html"
exit
`;
    fs.writeFileSync(path.join(reportDir, "View_Report.bat"), batScript);

    // Zip everything
    const timestamp = new Date()
      .toISOString()
      .replace(/[:.]/g, "-")
      .replace("T", "_")
      .split("Z")[0];

    const zipPath = path.join(backupDir, `Allure_Report_${timestamp}.zip`);
    const zip = new AdmZip();
    zip.addLocalFolder(reportDir);
    zip.writeZip(zipPath);

    console.log(`ğŸ“¦ Report zipped successfully: ${zipPath}`);
    console.log("âœ… Share this zip with your manager. They can unzip and just double-click 'View_Report.bat'!");
  } catch (error) {
    console.error("âŒ Error in globalTeardown:", error);
  }
}